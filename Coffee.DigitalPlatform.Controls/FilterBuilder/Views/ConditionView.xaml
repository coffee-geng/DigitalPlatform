<UserControl x:Class="Coffee.DigitalPlatform.Controls.FilterBuilder.ConditionView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:local="clr-namespace:Coffee.DigitalPlatform.Controls.FilterBuilder"
             xmlns:xctk="http://schemas.xceed.com/wpf/xaml/toolkit"
             xmlns:fb="clr-namespace:Coffee.DigitalPlatform.Controls.FilterBuilder"
             xmlns:control="clr-namespace:Coffee.DigitalPlatform.Controls"
             mc:Ignorable="d"
             d:DesignHeight="450" d:DesignWidth="800">
    <UserControl.Resources>
        <ResourceDictionary>
            <ResourceDictionary.MergedDictionaries>
                <ResourceDictionary Source="pack://application:,,,/Coffee.DigitalPlatform.Controls;component/Themes/Geometry.xaml" />
                <ResourceDictionary Source="pack://application:,,,/Coffee.DigitalPlatform.Controls;component/Themes/Generic.xaml" />
            </ResourceDictionary.MergedDictionaries>

            <BooleanToVisibilityConverter x:Key="b2v" />

            <sys:String x:Key="FilterBuilder_AddExpression">FilterBuilder_AddExpression</sys:String>
            <sys:String x:Key="FilterBuilder_AddGroup">FilterBuilder_AddGroup</sys:String>
            <sys:String x:Key="FilterBuilder_DeleteItem">FilterBuilder_DeleteItem</sys:String>
        </ResourceDictionary>
    </UserControl.Resources>
    <Grid MinHeight="100" MaxHeight="200">
        <TreeView x:Name="PART_ConditionTreeView" ScrollViewer.VerticalScrollBarVisibility="Visible"
          BorderThickness="1" Margin="25 6 6 6" BorderBrush="Transparent"
          ItemsSource="{Binding FilterScheme.ConditionItems}">
            <TreeView.Resources>
                <Style TargetType="{x:Type DatePicker}" BasedOn="{StaticResource {x:Type DatePicker}}">
                    <Setter Property="Width" Value="173" />
                    <Setter Property="Margin" Value="2" />
                    <Setter Property="Padding" Value="2 4 2 2" />
                    <Setter Property="Height" Value="26" />
                </Style>

                <Style TargetType="{x:Type TextBox}" BasedOn="{StaticResource {x:Type TextBox}}">
                    <Setter Property="Width" Value="173" />
                    <Setter Property="MinWidth" Value="123" />
                    <Setter Property="Margin" Value="2" />
                    <Setter Property="VerticalContentAlignment" Value="Center" />
                </Style>

                <Style TargetType="{x:Type control:NumericUpDown}" BasedOn="{StaticResource NumericUpDownStyle}">
                    <Setter Property="Height" Value="26" />
                    <Setter Property="Width" Value="173" />
                    <Setter Property="MinWidth" Value="123" />
                    <Setter Property="Margin" Value="2" />
                    <Setter Property="VerticalContentAlignment" Value="Center" />
                </Style>

                <Style TargetType="{x:Type Button}" BasedOn="{StaticResource {x:Type Button}}">
                    <Setter Property="Margin" Value="2"/>
                    <Setter Property="Height" Value="26"/>
                    <Setter Property="Width" Value="26"/>
                    <Setter Property="OverridesDefaultStyle" Value="True"/>
                    <Setter Property="VerticalContentAlignment" Value="Center"/>
                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                    <Setter Property="SnapsToDevicePixels" Value="True"/>
                </Style>
            </TreeView.Resources>
            <TreeView.ItemContainerStyle>
                <Style TargetType="{x:Type TreeViewItem}" BasedOn="{StaticResource FilterBuilderTreeViewItemStyle}"/>
            </TreeView.ItemContainerStyle>
            <TreeView.ItemTemplate>
                <HierarchicalDataTemplate ItemsSource="{Binding Items}">
                    <Grid HorizontalAlignment="Stretch" Background="Transparent">
                        <StackPanel Orientation="Horizontal" Margin="0"
                            Visibility="{Binding Converter={x:Static fb:ConditionTreeItemConverter.Instance}, ConverterParameter=Group}">
                            <ComboBox x:Name="PART_GroupTypeComboBox"
                              ItemsSource="{fb:EnumBinding {x:Type fb:ConditionGroupType}}"
                              SelectedItem="{Binding Type}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding ., Converter={x:Static fb:ConditionGroupTypeNameConverter.Instance}}" VerticalAlignment="Center" HorizontalAlignment="Left"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <Button x:Name="PART_AddExpressionButton"
                            ToolTip="{Binding ., Source={StaticResource FilterBuilder_AddExpression}, Converter={x:Static fb:TextResourceConverter.Instance}}"
                            BorderThickness="0"
                            Command="{Binding DataContext.AddExpressionCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=TreeView}}"
                            CommandParameter="{Binding }">
                                <Path Data="{StaticResource AddGeometry}"
                                  Margin="2"
                                  Stretch="Fill"
                                  Fill="{Binding Path=Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Button}}}"/>
                            </Button>

                            <Button x:Name="PART_AddGroupButton"
                                ToolTip="{Binding ., Source={StaticResource FilterBuilder_AddGroup}, Converter={x:Static fb:TextResourceConverter.Instance}}"
                                BorderThickness="0"
                                Command="{Binding DataContext.AddGroupCommand, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=TreeView}}"
                                CommandParameter="{Binding }">
                                <Path Data="{StaticResource AddGroupGeometry}"
                                  Margin="2"
                                  Stretch="Fill"
                                  Fill="{Binding Path=Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Button}}}"/>
                            </Button>

                            <Button x:Name="PART_DeleteGroupButton"
                                ToolTip="{Binding ., Source={StaticResource FilterBuilder_DeleteItem}, Converter={x:Static fb:TextResourceConverter.Instance}}" 
                                Padding="3"
                                BorderThickness="0"
                                Command="{Binding DataContext.DeleteConditionItem, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=TreeView}}"
                                CommandParameter="{Binding }"
                                Visibility="{Binding RelativeSource={RelativeSource Self}, Path=IsEnabled, Converter={StaticResource b2v}}">
                                <Path Data="{StaticResource DeleteGeometry}"
                                  Margin="2"
                                  Stretch="Fill"
                                  Fill="{Binding Path=Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Button}}}"/>
                            </Button>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Margin="0"
                            Visibility="{Binding Converter={x:Static fb:ConditionTreeItemConverter.Instance}, ConverterParameter=Expression}">
                            <ComboBox x:Name="PART_PropertiesComboBox"
                              ItemsSource="{Binding DataContext.InstanceProperties, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=TreeView}}"
                              DisplayMemberPath="DisplayName" SelectedItem="{Binding Property, NotifyOnValidationError=True, ValidatesOnDataErrors=True}" />

                            <ComboBox x:Name="PART_ConditionComboBox"
                              ItemsSource="{Binding DataTypeExpression, Converter={x:Static fb:DataTypeExpressionToConditionsConverter.Instance}}"
                              SelectedItem="{Binding DataTypeExpression.SelectedCondition}">
                                <ComboBox.ItemTemplate>
                                    <DataTemplate>
                                        <TextBlock Text="{Binding ., Converter={x:Static fb:ConditionNameConverter.Instance}}" VerticalAlignment="Center" HorizontalAlignment="Left"/>
                                    </DataTemplate>
                                </ComboBox.ItemTemplate>
                            </ComboBox>

                            <Grid Visibility="{Binding DataTypeExpression.IsValueRequired, Converter={StaticResource b2v}}" Margin="0">
                                <TextBox x:Name="PART_ValueTextBox"
                                     Text="{Binding DataTypeExpression.Value}" Height="26"
                                     Visibility="{Binding DataTypeExpression.ValueControlType, Converter={x:Static fb:ValueControlTypeVisibilityConverter.Instance}, ConverterParameter={x:Static fb:ValueControlType.Text}}">
                                </TextBox>

                                <control:NumericUpDown x:Name="PART_ValueNumericUpDown"             
                                    Value="{Binding DataTypeExpression.Value, Mode=TwoWay}"
                                    ValueControlType="{Binding DataTypeExpression.ValueControlType}">
                                    <control:NumericUpDown.Visibility>
                                        <Binding Path="DataTypeExpression.ValueControlType" Converter="{x:Static fb:ValueControlTypeVisibilityConverter.Instance}">
                                            <Binding.ConverterParameter>
                                                <x:Array Type="{x:Type fb:ValueControlType}">
                                                    <fb:ValueControlType>Byte</fb:ValueControlType>
                                                    <fb:ValueControlType>SByte</fb:ValueControlType>
                                                    <fb:ValueControlType>Short</fb:ValueControlType>
                                                    <fb:ValueControlType>UnsignedShort</fb:ValueControlType>
                                                    <fb:ValueControlType>Integer</fb:ValueControlType>
                                                    <fb:ValueControlType>UnsignedInteger</fb:ValueControlType>
                                                    <fb:ValueControlType>Long</fb:ValueControlType>
                                                    <fb:ValueControlType>UnsignedLong</fb:ValueControlType>
                                                    <fb:ValueControlType>Decimal</fb:ValueControlType>
                                                    <fb:ValueControlType>Float</fb:ValueControlType>
                                                    <fb:ValueControlType>Double</fb:ValueControlType>
                                                    <fb:ValueControlType>Numeric</fb:ValueControlType>
                                                </x:Array>
                                            </Binding.ConverterParameter>
                                        </Binding>
                                    </control:NumericUpDown.Visibility>
                                </control:NumericUpDown>

                                <xctk:DateTimePicker x:Name="PART_ValueDateTimePicker"
                                    Value="{Binding DataTypeExpression.Value, Converter={x:Static fb:EnsureDateTimeValueConverter.Instance}}"    
                                    Visibility="{Binding DataTypeExpression.ValueControlType, Converter={x:Static fb:ValueControlTypeVisibilityConverter.Instance}, ConverterParameter={x:Static fb:ValueControlType.DateTime}}"/>

                                <ComboBox x:Name="PART_BooleanValueComboBox"
                                  ItemsSource="{Binding DataTypeExpression.BooleanValues}"
                                  SelectedValue="{Binding DataTypeExpression.Value}"
                                  Visibility="{Binding DataTypeExpression.ValueControlType, Converter={x:Static fb:ValueControlTypeVisibilityConverter.Instance}, ConverterParameter={x:Static fb:ValueControlType.Boolean}}"/>

                                <ComboBox x:Name="PART_EnumValueComboBox"
                                  ItemsSource="{Binding DataTypeExpression.EnumValues}"
                                  SelectedValue="{Binding DataTypeExpression.Value}"
                                  Visibility="{Binding DataTypeExpression.ValueControlType, Converter={x:Static fb:ValueControlTypeVisibilityConverter.Instance}, ConverterParameter={x:Static fb:ValueControlType.Enum}}"/>

                                <xctk:TimeSpanUpDown x:Name="PART_ValueTimeSpanPicker"
                                    Value="{Binding DataTypeExpression.Value, Converter={x:Static fb:EnsureTimeSpanValueConverter.Instance}}"
                                    Visibility="{Binding DataTypeExpression.ValueControlType, Converter={x:Static fb:ValueControlTypeVisibilityConverter.Instance}, ConverterParameter={x:Static fb:ValueControlType.TimeSpan}}"/>
                            </Grid>

                            <Button x:Name="PART_DeleteExpressionButton"
                                BorderThickness="0" Padding="3"
                                ToolTip="{Binding ., Source={StaticResource FilterBuilder_DeleteItem}, Converter={x:Static fb:TextResourceConverter.Instance}}" 
                                Command="{Binding DataContext.DeleteConditionItem, RelativeSource={RelativeSource Mode=FindAncestor, AncestorType=TreeView}}"
                                CommandParameter="{Binding}">
                                <Path Data="{StaticResource DeleteGeometry}"
                                  Margin="2" Stretch="Fill"
                                  Fill="{Binding Path=Foreground, RelativeSource={RelativeSource FindAncestor, AncestorType={x:Type Button}}}"/>
                            </Button>
                        </StackPanel>
                    </Grid>
                </HierarchicalDataTemplate>
            </TreeView.ItemTemplate>
        </TreeView>
    </Grid>
</UserControl>
